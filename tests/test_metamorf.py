import pytest

from web3 import Web3

from brownie import accounts, config, network 
from brownie import Factory, Test1, Test2

#init bytecode for Test1 (gotten from deploy tx data)
test1_init = "0x608060405234801561001057600080fd5b5061017b806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806306540f7e1461004657806324d97a4a146100645780634ef65c3b1461006e575b600080fd5b61004e61008a565b60405161005b91906100cc565b60405180910390f35b61006c610090565b005b61008860048036038101906100839190610118565b6100a9565b005b60005481565b3373ffffffffffffffffffffffffffffffffffffffff16ff5b8060008190555050565b6000819050919050565b6100c6816100b3565b82525050565b60006020820190506100e160008301846100bd565b92915050565b600080fd5b6100f5816100b3565b811461010057600080fd5b50565b600081359050610112816100ec565b92915050565b60006020828403121561012e5761012d6100e7565b5b600061013c84828501610103565b9150509291505056fea2646970667358221220a03d218c0b9b9ef209be0e346827ea8e59ee88bef75b0ecef770de5c0273945164736f6c63430008090033"
#init bytecode for Test2
test2_init = "0x608060405234801561001057600080fd5b50610210806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806306540f7e1461004657806324d97a4a146100645780634ef65c3b1461006e575b600080fd5b61004e61008a565b60405161005b91906100d8565b60405180910390f35b61006c610090565b005b61008860048036038101906100839190610124565b6100a9565b005b60005481565b3373ffffffffffffffffffffffffffffffffffffffff16ff5b8060026100b69190610180565b60008190555050565b6000819050919050565b6100d2816100bf565b82525050565b60006020820190506100ed60008301846100c9565b92915050565b600080fd5b610101816100bf565b811461010c57600080fd5b50565b60008135905061011e816100f8565b92915050565b60006020828403121561013a576101396100f3565b5b60006101488482850161010f565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061018b826100bf565b9150610196836100bf565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156101cf576101ce610151565b5b82820290509291505056fea264697066735822122098e5ad3df1e9374dacfdec5bdaafb631f894ee675117d43d1d73c6d1596f977f64736f6c63430008090033"
#init bytecode for the metamorfic contract
metamorfic_code = "0x5860208158601c335a63aaf10f428752fa158151803b80938091923cf3"

web3 = Web3()

def test_meta(accounts, Factory, Test1, Test2):
    factory = Factory.deploy({'from': accounts[0]})
    #deploy Test1 through factory
    factory.deploy(1, test1_init, {'from': accounts[0]})
    addr = str(factory.getMetamorphicContractAddress(1, metamorfic_code))
    
    #test1 only used for encoding data
    test1 = Test1.deploy({'from': accounts[0]})
    #encode data for raw eth.call/transaction
    set_uint = test1.setUint.encode_input(1)
    get_uint = test1.myUint.encode_input()

    web3.eth.send_transaction({'to': addr, 'data': set_uint, 'from': str(accounts[0])})

    print(f"result: {web3.eth.call({'to': addr, 'data': get_uint, 'from': str(accounts[0])}).hex()}")

    #kill metamorfic contract to enable creation of a new contract on the same addr
    kill = encoded_data = test1.killme.encode_input()
    web3.eth.send_transaction({'to': addr, 'data': kill, 'from': str(accounts[0])})

    #deploy new contract on the same address with a new bytecode 
    factory.deploy(1, test2_init, {'from': accounts[0]})
    
    web3.eth.send_transaction({'to': addr, 'data': set_uint, 'from': str(accounts[0])})

    print(f"result: {web3.eth.call({'to': addr, 'data': get_uint, 'from': str(accounts[0])}).hex()}")
